# Publish PowerShell module to PowerShell Gallery (manual-friendly)
# Triggers:
#  - Manual run from Actions (workflow_dispatch) so you can publish on demand.
#  - When a GitHub Release is published (release: published) for manual release workflow.
#
# Required secret:
#  - PSGALLERY_API_KEY (Repository → Settings → Secrets → Actions)
#
# Default MODULE_PATH is repo root; override via workflow inputs when running manually.

name: Publish to PowerShell Gallery (Manual)

on:
  workflow_dispatch:
    inputs:
      module_path:
        description: 'Path to module folder containing the .psd1 (relative to repo root)'
        required: false
        default: '.'
  release:
    types: [published]

permissions:
  contents: read

jobs:
  publish:
    runs-on: ubuntu-latest
    if: github.event_name == 'release' || github.event_name == 'workflow_dispatch'
    env:
      # default, can be overridden by workflow_dispatch input
      MODULE_PATH: ${{ github.event.inputs.module_path || '.' }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup PowerShell
        uses: PowerShell/setup-powershell@v2
        with:
          pwsh-version: 'latest'

      - name: Ensure NuGet provider and PowerShellGet
        shell: pwsh
        run: |
          Install-PackageProvider -Name NuGet -Force -Scope CurrentUser
          Install-Module -Name PowerShellGet -Force -Scope CurrentUser
          Import-Module PowerShellGet

      - name: Validate module manifest exists
        shell: pwsh
        run: |
          $path = Resolve-Path -LiteralPath "${{ env.MODULE_PATH }}" -ErrorAction Stop
          $manifests = Get-ChildItem -Path $path -Filter '*.psd1' -File -Recurse:$false -ErrorAction SilentlyContinue
          if ($null -eq $manifests -or $manifests.Count -eq 0) {
            Write-Error "No .psd1 manifest found in $path. Set module_path when running manually or update MODULE_PATH."
            exit 1
          }
          Write-Host "Found manifest: $($manifests[0].FullName)"
          try {
            $meta = Test-ModuleManifest -Path $manifests[0].FullName
            Write-Host "ModuleVersion: $($meta.Version)"
          } catch {
            Write-Warning "Could not parse ModuleVersion with Test-ModuleManifest; ensure your .psd1 has a ModuleVersion field."
          }

      - name: Publish module to PowerShell Gallery
        shell: pwsh
        env:
          PSGALLERY_API_KEY: ${{ secrets.PSGALLERY_API_KEY }}
        run: |
          $modulePath = Resolve-Path -LiteralPath "${{ env.MODULE_PATH }}"
          Write-Host "Publishing module from $modulePath to PSGallery..."
          Publish-Module -Path $modulePath -Repository PSGallery -NuGetApiKey $env:PSGALLERY_API_KEY -Force -Verbose

      - name: Done
        if: ${{ success() }}
        run: echo "Publish job finished."
